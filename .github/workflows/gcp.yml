name: Build and Push Flask App Image to Google Cloud Platform
on:
  push:
    branches: [main]

jobs:
  build-push-gcr:
    name: Build and Push to GCP
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: vto-docker-image
      PROJECT_ID: virtual-try-on-420112
      LOCATION: northamerica-northeast2-docker.pkg.dev

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure GCP credentials
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: "${{ secrets.VTO_SECRETS }}"

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'
  
    - name: 'Use gcloud CLI'
      run: 'gcloud auth list --filter=status:ACTIVE --format="value(account)"'

    - name: Build Docker Image
      run: docker build -t $IMAGE_NAME:latest .

    - name: Configure Docker Client
      run: gcloud auth configure-docker $LOCATION --quiet

    - name: Push Docker Image to Artifact Registry
      env:
        GIT_TAG: v0.1.0
      run: |
        docker tag $IMAGE_NAME:latest $LOCATION/$PROJECT_ID/vto-artifact/$IMAGE_NAME:latest
        docker tag $IMAGE_NAME:latest $LOCATION/$PROJECT_ID/vto-artifact/$IMAGE_NAME:$GIT_TAG
        docker push $LOCATION/$PROJECT_ID/vto-artifact/$IMAGE_NAME:latest
        docker push $LOCATION/$PROJECT_ID/vto-artifact/$IMAGE_NAME:$GIT_TAG

  # deploy-to-compute-engine:
  #   name: Deploy to Compute Engine (using SSH)
  #   runs-on: ubuntu-latest
  #   needs: build-push-gcr

  #   steps:
  #   - name: Use SSH to deploy
  #     uses: google-github-actions/ssh-compute@v1
  #     with:
  #       instance_name: vto-vm-instance
  #       zone: northamerica-northeast2-a
  #       user: your-ssh-username
  #       private_key: ${{ secrets.VTO_SSH_KEY }}
  #       command: |
  #         gcloud docker --region=your-vm-region pull northamerica-northeast2-docker.pkg.dev/virtual-try-on-420112/vto-artifact/vto-image:latest
  #         docker run -d -p 8080:8080 northamerica-northeast2-docker.pkg.dev/virtual-try-on-420112/vto-artifact/vto-image:latest


  #         gcloud compute ssh --zone "northamerica-northeast2-a" "vto-vm-instance" --project "virtual-try-on-420112"